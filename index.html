<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USIU Marketplace</title>
    
    <style>
        /* CSS Styles */
        :root {
            --usiu-blue: #003366;
            --usiu-yellow: #FFCC00;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
            --medium-gray: #777;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-header {
            background-color: var(--usiu-blue);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-header .logo h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .main-nav ul {
            display: flex;
            list-style: none;
        }

        .main-nav ul li {
            margin-right: 20px;
        }

        .main-nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .main-nav ul li a:hover {
            color: var(--usiu-yellow);
        }

        .main-nav ul li a.active {
            color: var(--usiu-yellow);
            border-bottom: 2px solid var(--usiu-yellow);
        }

        .btn-primary {
            background-color: var(--usiu-yellow);
            color: var(--usiu-blue);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #e6b800;
        }

        .search-bar {
            display: flex;
            margin: 20px 0;
        }

        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 1rem;
        }

        .search-bar button {
            border-radius: 0 4px 4px 0;
        }

        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-btn {
            background-color: white;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background-color: var(--light-gray);
        }

        .category-btn.active {
            background-color: var(--usiu-blue);
            color: white;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            height: 200px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 15px;
        }

        .product-price {
            font-weight: bold;
            color: var(--usiu-blue);
            margin: 5px 0;
        }

        .product-category {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }

        /* Auth Page Styles */
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--medium-gray);
            position: relative;
        }

        .tab-btn.active {
            color: var(--usiu-blue);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--usiu-blue);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Product Detail Styles */
        .product-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .product-images {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .main-product-image {
            height: 400px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }

        .main-product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .thumbnail-container {
            display: flex;
            gap: 10px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            background-color: #eee;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .seller-info, .product-description {
            margin: 20px 0;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .product-detail {
                grid-template-columns: 1fr;
            }
            
            .main-header {
                flex-direction: column;
                text-align: center;
            }
            
            .main-nav ul {
                justify-content: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="auth-page" class="auth-container"> <div class="logo" style="text-align: center; margin-bottom: 20px;">
                <h1>USIU Marketplace</h1>
                <p>Buy and sell within the USIU community</p>
            </div>
            
            <div class="auth-tabs">
                <button class="tab-btn active" id="login-tab">Login</button>
                <button class="tab-btn" id="signup-tab">Sign Up</button>
            </div>
            
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">USIU Email (@usiu.ac.ke)</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
            
            <form id="signup-form" class="auth-form">
                <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">USIU Email (@usiu.ac.ke)</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required>
                </div>
                <div class="form-group">
                    <label for="signup-confirm">Confirm Password</label>
                    <input type="password" id="signup-confirm" required>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number (Optional)</label>
                    <input type="tel" id="signup-phone">
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
        
        <div id="main-app-page" style="display: none;">
            <header class="main-header">
                <div class="container" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="logo"><h1>USIU Marketplace</h1></div>
                    <nav class="main-nav">
                        <ul>
                            <li><a href="#" class="nav-link" data-page="dashboard">Home</a></li>
                            <li><a href="#" class="nav-link" data-page="my-listings">My Listings</a></li>
                            <li><a href="#" class="nav-link" data-page="post-product">Sell Item</a></li>
                            <li><a href="#" id="logout-btn">Logout</a></li>
                        </ul>
                    </nav>
                </div>
            </header>
            
            <main id="main-content" class="container"></main>
            
            <footer class="main-footer" style="text-align: center; padding: 20px; margin-top: 30px;">
                <p>&copy; 2025 USIU Marketplace. For USIU community only.</p>
            </footer>
        </div>

        <div id="product-detail-page" style="display: none;">
            </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================
            // 1. CONFIGURATION & STATE
            // =================================================================
            const API_URL = 'https://campuskart-backend-unqp.onrender.com';
            let authToken = localStorage.getItem('token');

            const state = {
                currentUser: null,
                products: [],
            };

            // =================================================================
            // 2. DOM ELEMENT SELECTORS (Static elements that always exist)
            // =================================================================
            const app = document.getElementById('app');
            const authPage = document.getElementById('auth-page');
            const mainAppPage = document.getElementById('main-app-page');
            const mainContent = document.getElementById('main-content');
            const productDetailPage = document.getElementById('product-detail-page');
            
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            // =================================================================
            // 3. CORE APP LOGIC (Routing, Initialization)
            // =================================================================

            // This is the main entry point when the page loads
            function handleEmailVerification() {
                const urlParams = new URLSearchParams(window.location.search);
                const verificationToken = urlParams.get('token');

                if (verificationToken) {
                    // A token is in the URL, so verify it
                    document.body.innerHTML = '<h1>Verifying your email, please wait...</h1>';
                    fetch(`${API_URL}/api/users/verify?token=${verificationToken}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Verification link is invalid or has expired.');
                            return response.text();
                        })
                        .then(successHtml => {
                            document.body.innerHTML = successHtml;
                            const mainPageUrl = window.location.origin + window.location.pathname;
                            document.body.innerHTML += `<br><br><a href="${mainPageUrl}" style="color: var(--usiu-blue); font-weight: bold;">Click here to go to the login page</a>`;
                        })
                        .catch(error => {
                            document.body.innerHTML = `<h1>Verification Failed</h1><p>${error.message}</p>`;
                        });
                } else {
                    // No token, start the app normally
                    init();
                }
            }

            // Initializes the app state based on whether a user is logged in
            function init() {
                if (authToken) {
                    showPage('dashboard');
                } else {
                    showPage('auth');
                }
                setupEventListeners();
            }

            // Controls which main view is visible and what content is loaded
            function showPage(page) {
                authPage.style.display = 'none';
                mainAppPage.style.display = 'none';
                productDetailPage.style.display = 'none';

                if (page === 'auth') {
                    authPage.style.display = 'block';
                } else if (page === 'product-detail') {
                    productDetailPage.style.display = 'block';
                } else {
                    mainAppPage.style.display = 'block';
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.toggle('active', link.dataset.page === page);
                    });
                    if (page === 'dashboard') loadProducts();
                    else if (page === 'my-listings') showMyListings();
                    else if (page === 'post-product') renderProductForm();
                }
            }

            // =================================================================
            // 4. EVENT LISTENERS
            // =================================================================

            // Sets up all the event listeners for the application
            function setupEventListeners() {
                // --- Static Listeners (for elements that always exist) ---
                loginTab.addEventListener('click', () => switchAuthTab('login'));
                signupTab.addEventListener('click', () => switchAuthTab('signup'));
                loginForm.addEventListener('submit', handleLogin);
                signupForm.addEventListener('submit', handleSignup);
                
                // Use event delegation for nav links since they exist in multiple headers
                app.addEventListener('click', (e) => {
                    if (e.target.matches('.nav-link')) {
                        e.preventDefault();
                        showPage(e.target.dataset.page);
                    }
                    if (e.target.matches('#logout-btn') || e.target.matches('#logout-btn-detail')) {
                        e.preventDefault();
                        handleLogout();
                    }
                    if (e.target.matches('.back-link')) {
                        e.preventDefault();
                        showPage('dashboard');
                    }
                });

                // --- Delegated Listeners (for dynamic content) ---
                mainContent.addEventListener('click', (e) => {
                    // Listener for dynamic search button
                    if (e.target.matches('#search-btn')) {
                        const query = mainContent.querySelector('#search-input').value;
                        loadProducts({ search: query });
                    }
                    // Listener for dynamic category buttons
                    if (e.target.matches('.category-btn')) {
                        const category = e.target.dataset.category;
                        loadProducts(category === 'all' ? {} : { category });
                    }
                    // Listener for dynamic delete buttons
                    if (e.target.matches('.delete-item-btn')) {
                        const itemId = e.target.dataset.id;
                        handleDeleteItem(itemId);
                    }
                });

                // Listener for dynamic "Post Item" form
                mainContent.addEventListener('submit', (e) => {
                    if (e.target.matches('#product-form')) {
                        handleProductSubmit(e);
                    }
                });
            }

            // =================================================================
            // 5. AUTHENTICATION & USER FUNCTIONS
            // =================================================================
            
            async function handleSignup(e) {
                e.preventDefault();
                const name = signupForm.querySelector('#signup-name').value;
                const email = signupForm.querySelector('#signup-email').value;
                const password = signupForm.querySelector('#signup-password').value;
                const confirmPassword = signupForm.querySelector('#signup-confirm').value;
                const phone = signupForm.querySelector('#signup-phone').value;
                if (password !== confirmPassword) return alert('Passwords do not match');
                const nameParts = name.trim().split(' ');
                const firstName = nameParts[0];
                const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
                try {
                    const response = await fetch(`${API_URL}/api/users/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ firstName, lastName, usiuEmail: email, password, phone_number: phone })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert('Signup successful! Please check your email to verify your account.');
                    signupForm.reset();
                    switchAuthTab('login');
                } catch (error) {
                    alert(`Signup Error: ${error.message}`);
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                const email = loginForm.querySelector('#login-email').value;
                const password = loginForm.querySelector('#login-password').value;
                try {
                    const response = await fetch(`${API_URL}/api/users/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usiuEmail: email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert('Login successful!');
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    showPage('dashboard');
                } catch (error) {
                    alert(`Login Error: ${error.message}`);
                }
            }
            
            function handleLogout() {
                authToken = null;
                localStorage.removeItem('token');
                showPage('auth');
                alert('You have been logged out.');
            }

            function switchAuthTab(tab) {
                loginTab.classList.toggle('active', tab === 'login');
                signupTab.classList.toggle('active', tab === 'signup');
                loginForm.classList.toggle('active', tab === 'login');
                signupForm.classList.toggle('active', tab === 'signup');
            }

            // =================================================================
            // 6. API & RENDER FUNCTIONS (For content)
            // =================================================================

            async function loadProducts(params = {}) {
                mainContent.innerHTML = '<h2>Loading products...</h2>';
                const query = new URLSearchParams(params).toString();
                try {
                    const response = await fetch(`${API_URL}/api/items?${query}`);
                    if (!response.ok) throw new Error('Failed to fetch products');
                    const products = await response.json();
                    renderProducts(products);
                } catch (error) {
                    mainContent.innerHTML = `<p>Error: ${error.message}</p>`;
                }
            }
            
            function renderProducts(products) {
                mainContent.innerHTML = `
                    <div class="search-bar">
                        <input type="text" placeholder="Search for books, electronics..." id="search-input">
                        <button class="btn-primary" id="search-btn">Search</button>
                    </div>
                    <div class="categories" id="categories-container">
                        <button class="category-btn active" data-category="all">All</button>
                        <button class="category-btn" data-category="Books">Books</button>
                        <button class="category-btn" data-category="Electronics">Electronics</button>
                        <button class="category-btn" data-category="Furniture">Furniture</button>
                        <button class="category-btn" data-category="Clothing">Clothing</button>
                        <button class="category-btn" data-category="Other">Other</button>
                    </div>
                    <div class="products-grid" id="products-container"></div>`;
                const container = mainContent.querySelector('#products-container');
                if (products.length === 0) {
                    container.innerHTML = '<p>No products found matching your criteria.</p>';
                    return;
                }
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-image"><img src="${product.image_url}" alt="${product.title}"></div>
                        <div class="product-info">
                            <h3>${product.title}</h3>
                            <p class="product-price">KSH ${product.price.toLocaleString()}</p>
                            <p class="product-category">${product.category}</p>
                        </div>`;
                    card.addEventListener('click', () => showProductDetail(product.item_id));
                    container.appendChild(card);
                });
            }

            async function showMyListings() {
                mainContent.innerHTML = '<h2>Loading your listings...</h2>';
                try {
                    const response = await fetch(`${API_URL}/api/items/my-items`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    if (!response.ok) throw new Error('Could not fetch your items.');
                    const myItems = await response.json();
                    renderMyItems(myItems);
                } catch (error) {
                    mainContent.innerHTML = `<p>Error: ${error.message}</p>`;
                }
            }
            
            function renderMyItems(items) {
                mainContent.innerHTML = '<h2>My Listings</h2>';
                if (items.length === 0) {
                    mainContent.innerHTML += '<p>You have not posted any items yet. Click "Sell Item" to get started!</p>';
                    return;
                }
                const grid = document.createElement('div');
                grid.className = 'products-grid';
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-image"><img src="${item.image_url}" alt="${item.title}"></div>
                        <div class="product-info">
                            <h3>${item.title}</h3>
                            <p class="product-price">KSH ${item.price.toLocaleString()}</p>
                            <p>Status: ${item.listing_status}</p>
                            <button class="delete-item-btn" data-id="${item.item_id}">Delete 🗑️</button>
                        </div>`;
                    grid.appendChild(card);
                });
                mainContent.appendChild(grid);
            }

            function renderProductForm() {
                mainContent.innerHTML = `
                    <h2>Post a New Item</h2>
                    <form id="product-form">
                        <div class="form-group"><label>Product Name</label><input type="text" id="product-name" required></div>
                        <div class="form-group"><label>Category</label><select id="product-category" required><option value="">Select a category</option><option value="Books">Books</option><option value="Electronics">Electronics</option><option value="Furniture">Furniture</option><option value="Clothing">Clothing</option><option value="Other">Other</option></select></div>
                        <div class="form-group"><label>Price (KSH)</label><input type="number" id="product-price" min="0" required></div>
                        <div class="form-group"><label>Description</label><textarea id="product-description" rows="4" required></textarea></div>
                        <div class="form-group"><label>Upload Image</label><input type="file" id="product-images" accept="image/*" required></div>
                        <button type="submit" class="btn-primary">Post Item</button>
                    </form>`;
            }
            
            async function showProductDetail(itemId) {
                try {
                    const response = await fetch(`${API_URL}/api/items/${itemId}`);
                    if (!response.ok) throw new Error('Product not found.');
                    const product = await response.json();
                    
                    productDetailPage.querySelector('#detail-title').textContent = product.title;
                    productDetailPage.querySelector('#detail-price').textContent = `KSH ${Number(product.price).toLocaleString()}`;
                    productDetailPage.querySelector('#detail-category').textContent = product.category;
                    productDetailPage.querySelector('#detail-full-description').textContent = product.description;
                    productDetailPage.querySelector('#detail-seller-name').textContent = `Name: ${product.seller_name}`;
                    productDetailPage.querySelector('#detail-seller-email').textContent = `Email: ${product.seller_email}`;
                    productDetailPage.querySelector('#detail-seller-phone').textContent = `Phone: ${product.seller_phone || 'Not provided'}`;
                    productDetailPage.querySelector('#detail-main-image').src = product.image_url;
                    
                    showPage('product-detail');
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            async function handleProductSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const imageFile = form.querySelector('#product-images').files[0];
                if (!imageFile) return alert('An image is required.');
                
                const formData = new FormData();
                formData.append('title', form.querySelector('#product-name').value);
                formData.append('category', form.querySelector('#product-category').value);
                formData.append('price', form.querySelector('#product-price').value);
                formData.append('description', form.querySelector('#product-description').value);
                formData.append('image', imageFile);

                try {
                    const response = await fetch(`${API_URL}/api/items`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert('Product posted successfully!');
                    showPage('dashboard');
                } catch (error) {
                    alert(`Post Product Error: ${error.message}`);
                }
            }
            
            async function handleDeleteItem(itemId) {
                if (!confirm('Are you sure you want to delete this item?')) return;
                try {
                    const response = await fetch(`${API_URL}/api/items/${itemId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert('Item deleted successfully!');
                    showMyListings(); // Refresh the list
                } catch (error) {
                    alert(`Error deleting item: ${error.message}`);
                }
            }

            // =================================================================
            // 7. START THE APPLICATION
            // =================================================================
            handleEmailVerification();
        });
    </script>

    
</body>
</html>